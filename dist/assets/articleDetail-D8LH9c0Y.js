import{initializeApp as J}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getFirestore as K,enableIndexedDbPersistence as W,query as C,collection as E,where as y,orderBy as X,getDocs as b,limit as O,doc as A,getDoc as G,updateDoc as q,increment as H,addDoc as Q}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{getAuth as Y,onAuthStateChanged as Z}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const ee={apiKey:"AIzaSyCuFgzytJXD6jt4HUW9LVSD_VpGuFfcEAk",authDomain:"electroino-app.firebaseapp.com",projectId:"electroino-app",storageBucket:"electroino-app.firebasestorage.app",messagingSenderId:"864058526638",appId:"1:864058526638:web:17b821633c7cc99be1563f"},F=J(ee),d=K(F),te=Y(F);W(d).catch(e=>{e.code=="failed-precondition"?console.log("‚ö†Ô∏è Persistance Firebase: plusieurs onglets ouverts"):e.code=="unimplemented"&&console.log("‚ö†Ô∏è Navigateur ne supporte pas IndexedDB")});let l=null;const P="electroinfo_article_",ne=24*60*60*1e3;function w(e){return`${P}${e}`}function oe(e){try{const t={article:e,timestamp:Date.now()};localStorage.setItem(w(e.id),JSON.stringify(t)),console.log(`üíæ Article "${e.title}" sauvegard√© en cache`)}catch(t){console.error("Erreur sauvegarde cache article:",t)}}function k(e){try{const t=localStorage.getItem(w(e));if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>ne?(localStorage.removeItem(w(e)),null):(console.log("üì¶ Article charg√© depuis le cache"),n.article)}catch(t){return console.error("Erreur lecture cache article:",t),null}}function u(){return navigator.onLine}function v(){_();const e=document.createElement("div");e.id="offline-indicator",e.className="offline-indicator",e.innerHTML=`
        <i class="fas fa-wifi-slash"></i>
        <span>Mode hors ligne ‚Ä¢ Donn√©es en cache</span>
    `,document.body.prepend(e),document.body.style.paddingTop="44px",requestAnimationFrame(()=>{e.classList.add("show")})}function _(){const e=document.getElementById("offline-indicator");e&&(e.classList.remove("show"),setTimeout(()=>{e.remove(),document.body.style.paddingTop=""},300))}function re(){const e=localStorage.getItem("electroinfo-theme")||"light",t=document.getElementById("themeToggle"),n=document.getElementById("themeIcon"),r=document.getElementById("themeText");console.log("üé® Th√®me initial:",e),e==="dark"?(document.documentElement.setAttribute("data-theme","dark"),n&&(n.className="fas fa-sun"),r&&(r.textContent="Clair"),t&&t.classList.add("dark-mode")):(document.documentElement.removeAttribute("data-theme"),n&&(n.className="fas fa-moon"),r&&(r.textContent="Sombre"),t&&t.classList.remove("dark-mode"))}function ae(){const e=document.documentElement.getAttribute("data-theme"),t=e==="dark"?"light":"dark",n=document.getElementById("themeToggle"),r=document.getElementById("themeIcon"),o=document.getElementById("themeText");console.log("üé® Changement th√®me:",e,"‚Üí",t),t==="dark"?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("electroinfo-theme","dark"),r&&(r.className="fas fa-sun"),o&&(o.textContent="Clair"),n&&n.classList.add("dark-mode"),document.body.style.transition="background-color 0.3s ease, color 0.3s ease"):(document.documentElement.removeAttribute("data-theme"),localStorage.setItem("electroinfo-theme","light"),r&&(r.className="fas fa-moon"),o&&(o.textContent="Sombre"),n&&n.classList.remove("dark-mode"))}Z(te,e=>{});async function j(){const e=new URLSearchParams(window.location.search),t=e.get("id"),n=e.get("slug");console.log("üîç Chargement article:",{id:t,slug:n});try{let r=null;if(t&&(r=k(t)),r&&(console.log("‚ö° Affichage imm√©diat depuis le cache"),l=r,I(r),p(r.id),L(r),!u())){v();return}if(!u()){r||h("Aucune connexion Internet","Cet article n'est pas disponible hors ligne.");return}let o=null;if(n)o=await ie(n);else if(t)o=await ce(t);else{h("Article non trouv√©","Aucun identifiant d'article fourni.");return}if(!o){h("Article introuvable","Cet article n'existe pas ou a √©t√© supprim√©.");return}oe(o),(!r||JSON.stringify(r)!==JSON.stringify(o))&&(l=o,I(o),p(o.id),L(o)),pe(o.id).catch(console.error)}catch(r){if(console.error("Erreur chargement article:",r),t){const o=k(t);if(o){console.log("üì¥ Utilisation du cache suite √† une erreur"),l=o,I(o),p(o.id),L(o),v();return}}h("Erreur de chargement","Impossible de charger cet article. V√©rifiez votre connexion.")}}async function ce(e){try{const t=A(d,"articles",e),n=await G(t);return n.exists()?{id:n.id,...n.data()}:null}catch(t){throw console.error("Erreur loadArticleById:",t),t}}async function ie(e){try{console.log("üîç Recherche slug:",e);const t=C(E(d,"articles"),y("slug","==",e),O(1)),n=await b(t);if(!n.empty){const r=n.docs[0];return{id:r.id,...r.data()}}return null}catch(t){throw console.error("Erreur loadArticleBySlug:",t),t}}function I(e){var $,N,M;console.log("üé® Rendu article:",e.title),console.log("üñºÔ∏è Image URL from article:",e.imageUrl);const t=document.getElementById("loadingState");t&&t.classList.add("hidden");const n=document.getElementById("errorState");n&&n.classList.add("hidden");const r=document.getElementById("articleContainer");r&&r.classList.remove("hidden"),se(e);const o=document.getElementById("articleImage");if(console.log("üñºÔ∏è Element heroImage trouv√©:",o),o){const f=e.imageUrl||"https://images.unsplash.com/photo-1518770660439-4636190af475?w=1200";console.log("üñºÔ∏è URL image √† charger:",f),o.removeAttribute("src"),o.alt=e.title||"Image de couverture",o.onerror=function(){console.warn("‚ö†Ô∏è Erreur chargement image hero, utilisation fallback"),this.src="https://images.unsplash.com/photo-1518770660439-4636190af475?w=1200",this.onerror=null},o.onload=function(){console.log("‚úÖ Image hero charg√©e avec succ√®s"),this.classList.add("loaded")},o.src=f,o.complete&&(o.naturalHeight===0?(console.warn("‚ö†Ô∏è Image en cache mais invalide, rechargement..."),o.src=f+"?t="+Date.now()):(console.log("‚úÖ Image d√©j√† en cache et valide"),o.classList.add("loaded")))}else console.error("‚ùå Element #articleImage non trouv√©!");const a=document.getElementById("categoryBadge");a&&(a.textContent=e.category||"Article",a.className=`article-category-badge category-${ge(e.category)}`);const c=document.getElementById("articleTitle");c&&(c.textContent=e.title);const g=document.getElementById("authorName");g&&(g.textContent=e.authorName||(($=e.author)==null?void 0:$.name)||"√âquipe ElectroInfo");const B=document.getElementById("authorAvatar");if(B){const f=e.authorName||((N=e.author)==null?void 0:N.name)||"ElectroInfo";B.src=e.authorAvatar||((M=e.author)==null?void 0:M.avatar)||`https://ui-avatars.com/api/?name=${encodeURIComponent(f)}&background=1e40af&color=fff`}const S=document.getElementById("articleDate");S&&(S.textContent=z(e));const T=document.getElementById("viewsCount");T&&(T.textContent=`${e.views||0} vues`);const x=document.getElementById("readingTime");x&&(x.textContent=`${e.readTime||he(e.content)} min de lecture`);const D=document.getElementById("articleContent");D&&(D.innerHTML=e.content||e.body||"<p>Contenu non disponible</p>"),document.getElementById("tagsContainer")&&le(e.tags),de(e),me(e),document.body.classList.add("article-loaded"),console.log("‚úÖ Rendu article termin√©")}function se(e){document.title=`${e.title} | ElectroInfo`;let t=document.querySelector('meta[name="description"]');t||(t=document.createElement("meta"),t.name="description",document.head.appendChild(t)),t.content=e.summary||e.excerpt||e.title,m("og:title",e.title),m("og:description",e.summary||e.excerpt||""),m("og:image",e.imageUrl||"https://electroinfo.online/images/logo.png"),m("og:url",window.location.href),m("twitter:title",e.title),m("twitter:description",e.summary||e.excerpt||""),m("twitter:image",e.imageUrl||"https://electroinfo.online/images/logo.png")}function m(e,t){let n=document.querySelector(`meta[property="${e}"]`)||document.querySelector(`meta[name="${e}"]`);n||(n=document.createElement("meta"),e.startsWith("og:")?n.setAttribute("property",e):n.setAttribute("name",e),document.head.appendChild(n)),n.content=t}function le(e){const t=document.getElementById("tagsContainer");if(t){if(!e||e.length===0){t.innerHTML='<p class="empty-text">Aucun tag</p>';return}t.innerHTML=e.map(n=>`
        <span class="tag" onclick="filterByTag('${s(n)}')">
            ${s(n)}
        </span>
    `).join("")}}function de(e){["like","love","insight","support"].forEach(n=>{var o;const r=document.querySelector(`button[data-reaction="${n}"]`);if(r){const a=((o=e.reactions)==null?void 0:o[n])||0,c=r.querySelector("span");c&&(c.textContent=a),r.onclick=()=>ye(e.id)}})}function me(e){const t=encodeURIComponent(window.location.href),n=encodeURIComponent(e.title),r=document.getElementById("twitterShare"),o=document.getElementById("linkedinShare"),a=document.getElementById("whatsappShare");r&&(r.href=`https://twitter.com/intent/tweet?url=${t}&text=${n}`),o&&(o.href=`https://www.linkedin.com/sharing/share-offsite/?url=${t}`),a&&(a.href=`https://wa.me/?text=${n}%20${t}`)}async function p(e){try{if(!u()){const o=document.getElementById("commentsList");o&&(o.innerHTML='<p class="empty-text"><i class="fas fa-wifi-slash"></i> Commentaires non disponibles hors ligne</p>');return}const t=C(E(d,"comments"),y("articleId","==",e),X("createdAt","desc")),r=(await b(t)).docs.map(o=>({id:o.id,...o.data()}));ue(r)}catch(t){console.error("Erreur chargement commentaires:",t);const n=document.getElementById("commentsList");n&&(n.innerHTML='<p class="empty-text">Erreur de chargement des commentaires</p>')}}function ue(e){const t=document.getElementById("commentsList"),n=document.getElementById("commentsCount");if(n&&(n.textContent=e.length),!!t){if(e.length===0){t.innerHTML='<p class="empty-text">Aucun commentaire pour le moment. Soyez le premier !</p>';return}t.innerHTML=e.map(r=>`
        <div class="comment-item">
            <div class="comment-header">
                <img src="${r.authorAvatar||"https://ui-avatars.com/api/?name="+encodeURIComponent(r.authorName)+"&background=1e40af&color=fff"}" 
                     alt="${s(r.authorName)}" class="comment-avatar">
                <div class="comment-author-info">
                    <span class="comment-author">${s(r.authorName)}</span>
                    <span class="comment-date">${fe(r.createdAt)}</span>
                </div>
            </div>
            <p class="comment-text">${s(r.text)}</p>
        </div>
    `).join("")}}async function L(e){try{if(!u()){R(e);return}const t=C(E(d,"articles"),y("category","==",e.category),y("__name__","!=",e.id),O(3)),r=(await b(t)).docs.map(o=>({id:o.id,...o.data()}));V(r)}catch(t){console.error("Erreur articles connexes:",t),R(e)}}function R(e){try{const t=[];for(let r=0;r<localStorage.length;r++){const o=localStorage.key(r);if(o&&o.startsWith(P))try{const a=JSON.parse(localStorage.getItem(o));a.article&&a.article.id!==e.id&&t.push(a.article)}catch{}}const n=t.filter(r=>r.category===e.category).slice(0,3);V(n)}catch(t){console.error("Erreur cache connexes:",t);const n=document.getElementById("relatedArticles");n&&(n.innerHTML='<p class="empty-text">Articles connexes non disponibles hors ligne</p>')}}function V(e){const t=document.getElementById("relatedArticles");if(t){if(e.length===0){t.innerHTML='<p class="empty-text">Aucun article connexe</p>';return}t.innerHTML=e.map(n=>`
            <a href="${n.slug?`/article/${n.slug}`:`/article-detail.html?id=${n.id}`}" class="related-article-item">
                <img src="${n.imageUrl||"https://images.unsplash.com/photo-1518770660439-4636190af475?w=400"}" 
                     alt="${s(n.title)}" class="related-article-image"
                     onerror="this.src='https://images.unsplash.com/photo-1518770660439-4636190af475?w=400'">
                <div class="related-article-content">
                    <span class="related-article-category">${s(n.category)}</span>
                    <h4 class="related-article-title">${s(n.title)}</h4>
                    <span class="related-article-date">${z(n)}</span>
                </div>
            </a>
        `).join("")}}function ge(e){return{INNOVATION:"blue",S√âCURIT√â:"red",NOUVEAUT√â:"green",TUTO:"orange",DOMOTIQUE:"purple"}[e]||"blue"}function z(e){return e.createdAt?e.createdAt.toDate?e.createdAt.toDate().toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}):e.createdAt.seconds?new Date(e.createdAt.seconds*1e3).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}):new Date(e.createdAt).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}):"Date inconnue"}function fe(e){if(!e)return"";let t;return e.toDate?t=e.toDate():e.seconds?t=new Date(e.seconds*1e3):t=new Date(e),t.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}function he(e){if(!e)return 3;const t=e.replace(/<[^>]*>/g,"").split(/\s+/).length;return Math.ceil(t/200)}function s(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function h(e,t){const n=document.getElementById("loadingState");n&&n.classList.add("hidden");const r=document.getElementById("errorState");if(r){r.classList.remove("hidden");const a=r.querySelector("h2"),c=r.querySelector("p");a&&(a.textContent=e),c&&(c.textContent=t)}const o=document.getElementById("articleContainer");o&&o.classList.add("hidden")}async function pe(e){try{const t=A(d,"articles",e);await q(t,{views:H(1)})}catch(t){console.error("Erreur incr√©mentation vues:",t)}}async function ye(e,t){if(!u()){i("Connexion requise pour r√©agir","error");return}i("R√©action enregistr√©e !","success")}function i(e,t="info"){const n={success:"check-circle",error:"exclamation-circle",info:"info-circle"},r=document.createElement("div");r.className=`notification ${t}`,r.innerHTML=`<i class="fas fa-${n[t]}"></i><span>${s(e)}</span>`,document.body.appendChild(r),requestAnimationFrame(()=>r.classList.add("show")),setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>r.remove(),300)},3e3)}window.addEventListener("online",()=>{console.log("üåê Connexion r√©tablie"),_(),i("Connexion r√©tablie","success"),l&&j()});window.addEventListener("offline",()=>{console.log("üì¥ Connexion perdue"),v(),i("Mode hors ligne","info")});var U;(U=document.getElementById("commentForm"))==null||U.addEventListener("submit",async e=>{if(e.preventDefault(),!u()){i("Connexion requise pour commenter","error");return}if(!l){i("Erreur: article non charg√©","error");return}const t=document.getElementById("commentName"),n=document.getElementById("commentEmail"),r=document.getElementById("commentText"),o=t==null?void 0:t.value.trim(),a=n==null?void 0:n.value.trim(),c=r==null?void 0:r.value.trim();if(!o||!a||!c){i("Veuillez remplir tous les champs","error");return}try{await Q(E(d,"comments"),{articleId:l.id,authorName:o,authorEmail:a,text:c,createdAt:new Date});const g=A(d,"articles",l.id);await q(g,{commentsCount:H(1)}),i("Commentaire publi√© !","success"),t&&(t.value=""),n&&(n.value=""),r&&(r.value=""),p(l.id)}catch(g){console.error("Erreur publication commentaire:",g),i("Erreur lors de la publication","error")}});document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ Initialisation article-detail.js"),re();const e=document.getElementById("themeToggle");e?(e.addEventListener("click",ae),console.log("‚úÖ Bouton th√®me attach√©")):console.error("‚ùå Bouton themeToggle non trouv√©");const t=document.getElementById("mobileMenuToggle"),n=document.getElementById("navMenu");t&&n?(t.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),n.classList.toggle("active"),t.classList.toggle("active"),document.body.classList.toggle("menu-open");const a=t.querySelector("i");a&&(n.classList.contains("active")?(a.classList.remove("fa-bars"),a.classList.add("fa-times")):(a.classList.remove("fa-times"),a.classList.add("fa-bars"))),console.log("üì± Menu mobile toggled:",n.classList.contains("active"))}),n.querySelectorAll(".nav-link").forEach(o=>{o.addEventListener("click",()=>{n.classList.remove("active"),t.classList.remove("active"),document.body.classList.remove("menu-open");const a=t.querySelector("i");a&&(a.classList.remove("fa-times"),a.classList.add("fa-bars"))})}),document.addEventListener("click",o=>{if(n.classList.contains("active")&&!n.contains(o.target)&&!t.contains(o.target)){n.classList.remove("active"),t.classList.remove("active"),document.body.classList.remove("menu-open");const a=t.querySelector("i");a&&(a.classList.remove("fa-times"),a.classList.add("fa-bars"))}}),console.log("‚úÖ Menu mobile attach√©")):console.error("‚ùå √âl√©ments menu mobile non trouv√©s:",{mobileMenuToggle:!!t,navMenu:!!n}),j(),u()||v()});
